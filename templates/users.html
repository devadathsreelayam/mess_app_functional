{% extends "base.html" %}

{% block title %}Manage Users{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/view_inmates.css') }}">
{% endblock %}

{% block content %}
<div class="container">
    <h1>User Details</h1>

    <div class="wrapper" style="margin-bottom: 10px;">
        <button type="button" class="btn" onclick="showPopup('addUserPopup')" style="width: 90px;">Add User</button>
    </div>

    <div class="overflow-x">
        <table>
            <tr>
                <th>User ID</th>
                <th>User Name</th>
                <th>Department</th>
                <th>Mobile</th>
                <th>Added Date</th>
                <th>Active Status</th>
                <th>Role</th>
                <th>Actions</th>
            </tr>
            {% for user in users %}
            <tr>
                <td>{{ user['userid'] }}</td>
                <td>{{ user['user_name'] }}</td>
                <td>{{ user['department'] }}</td>
                <td>{{ user['mobile'] }}</td>
                <td>{{ user['added_date'] }}</td>
                <td>{{ (user['active_status']).capitalize() }}</td>
                
                <td>{{ (user['role']).capitalize() }}</td>
    
                <td class="actions">
                    {% if not user['role'] == 'admin' %}
                    <a href="" action="edit" user-id="{{ user['userid'] }}" onclick="editUser(this); return false;">
                        <span class="material-symbols-outlined">edit</span>
                    </a>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </table>
    </div>
</div>

<div class="backdrop" id="backdrop"></div>

<div class="popup" id="addUserPopup" style="max-height: 90vh; overflow-y: auto;">
    <h1 id="form-title">Add User</h1>
    <span class="material-symbols-outlined close-btn" id="closePopup" onclick="closePopup('addUserPopup')">close</span>
    <form id="userForm" action="/add_user" method="POST">
        <div class="input-item">
            <label for="userid" class="form-label">User ID</label>
            <input type="text" class="form-control" name="userid" id="userid" placeholder="Enter User ID" required>
        </div>

        <div class="input-item" id="password-input">
            <label for="password" class="form-label">Password</label>
            <input type="password" class="form-control" name="password" id="password" placeholder="Enter Password" required>
        </div>

        <div class="input-item">
            <label for="user_name" class="form-label">Name of User</label>
            <input type="text" class="form-control" name="user_name" id="user_name" placeholder="Enter Name" required>
        </div>

        <div class="input-item">
            <label for="department" class="form-label">Department</label>
            <input type="text" class="form-control" name="department" id="department" placeholder="Enter Department" required>
        </div>

        <div class="input-item">
            <label for="mobile" class="form-label">Mobile Number</label>
            <input type="text" class="form-control" name="mobile" id="mobile" placeholder="Enter Mobile Number" required>
        </div>

        <div class="input-item" style="display: none;">
            <label for="active_status" class="form-label">Active Status</label>
            <select name="active_status" id="active_status" class="form-control">
                <option disabled selected>Select Status</option>
                <option value="active">Active</option>
                <option value="suspended">Suspended</option>
            </select>
        </div>

        <div class="input-item">
            <label for="role" class="form-label">Role</label>
            <select name="role" id="role" class="form-control">
                <option disabled selected>Select Role</option>
                <option value="secretary">Secretary</option>
                <option value="steerer">Steerer</option>
                <option value="manager">Manager</option>
                <option value="user">User</option>
            </select>
        </div>

        <input type="submit" class="btn btn-long-m" value="Submit">
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
    function editUser(element) {
        const userId = element.getAttribute('user-id');
        console.log("User ID:", userId);

        fetch(`/get_user/${userId}`)
            .then(response => {
                console.log("Response status:", response.status); // Log status
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log("Fetch data:", data);
                if (data.error) {
                    alert(data.error);
                } else {
                    // Populate form fields
                    document.getElementById('userid').value = data.userid;
                    document.getElementById('user_name').value = data.user_name;
                    document.getElementById('department').value = data.department;
                    document.getElementById('mobile').value = data.mobile;
                    document.getElementById('active_status').value = data.active_status;
                    document.getElementById('role').value = data.role;

                    document.getElementById('userid').readOnly = true;
                    document.getElementById('form-title').innerText = 'Edit User';
                    document.getElementById('password').placeholder = 'Enter New Password';
                    document.querySelector('label[for="password"]').innerText = 'New Password';

                    document.getElementById('active_status').closest('div').style.display = 'flex';

                    // Update the form's action to point to the update URL
                    document.getElementById('userForm').action = `/update_user/${userId}`;

                    // Show the popup
                    document.getElementById('addUserPopup').style.display = 'block';
                }
            })
            .catch(error => {
                console.error('Error fetching user details:', error);
                alert('Failed to fetch user details.');
            });
    }

    function showPopup(id) {
        const popup = document.getElementById(id);
        popup.style.display = 'block';
    }

    function closePopup(id) {
        const popup = document.getElementById(id);
        popup.style.display = 'none';
    }
</script>
{% endblock %}